# Gitops pipelines

The gitops pipelines contain 2 pipelines that aim to illustrate an end to end CI/CD flow using gitops. 

* The `build-push-promote-pl` pipeline will enforce the governance policy, build the code, optionally signs the image, push it to the image registry, scan the image and conditionally promotes the service to the configured gitops repository.  


The pipeline invokes the following tasks to accomplish the steps listed: 
  * [build-push-promote-task.yaml](https://github.com/kabanero-io/kabanero-pipelines/blob/master/pipelines/incubator/events/build-push-promote-task.yaml)
    This task first does a pre-build goverance policy check to validate the stack version in the application repository is allowed to build based on the goverance policy that is configured. It then builds a container image from the artifacts in the git-source repository by using `appsody build`. The appsody build command leverages [Buildah](https://github.com/containers/buildah) to build the image. The command also generates the `app-deploy.yaml` that is used for deployment. If there is already a copy of the `app-deploy.yaml` file in the source repository, it is merged with the new one generated by this step. After the image is built, the image is then optionally signed if the necessary configuration is setup. Refer to the [image signing operator](https://github.com/kabanero-io/kabanero-security/tree/master/pipelines/samples/signing-operator) for more information on configuring image signing. The image is then pushed to the configured image registry.
        
    (Tech preview feature) A configmap called `gitops-map` in the Kabanero namespace can optionally be configured to promote the service to a gitops repo after the build.  The step will invoke the [`services promote`](https://github.com/rhd-gitops-example/services) command to create a PR with the updated `app-deploy.yaml` file in the configured gitops repo. The following key value pairs should be setup in the configmap:
    ```
    kind: ConfigMap 
    apiVersion: v1 
    metadata:
      name: gitops-map
      namespace: kabanero
    data:
      gitops-repository-url: <can be specified here if common for all the pipelines in the cluster or in the event mediator for specific versions of the pipeline> 
      gitops-repository-type: <github,gitlab,ghe>
      gitops-commit-user-name: <user_name_to_commit_using>
      gitops-commit-user-email: <user_email_to_commit_using>
    ```
    
    A secret called `gitops-token` also has to be created in the Kabanero namspace. This example yaml creates the secret.
    ```
    apiVersion: v1
    kind: Secret
    metadata:
      name: gitops-token
    annotations:
      tekton.dev/git-0: https://github.com
    namespace: kabanero
    type: kubernetes.io/basic-auth
    stringData:
      username: <gitops_repo_username>
      password: <gitops_repo_access_token>
    ```
    
*   * [image-scan-task.yaml](https://github.com/kabanero-io/kabanero-pipelines/blob/master/pipelines/incubator/events/image-scan-task.yaml)
    The `image-scan-task` task will initiate a container scan of the image published by the `build-push-task` using OpenSCAP.  The results of the scan are published in the logs of the task.

# Maven cache pipelines

The mavencache pipelines shows the use of Tekton workspaces and Kubernetes persistence to reduce the build time of maven projects.

These pipelines require a persistence volume claim name `kabanero-cache`, see ./sample-helper-files/mvncache/kabanero-cache-pvc.yaml for an example.
